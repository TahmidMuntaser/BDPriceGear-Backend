name: Manual Database Update

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      limit:
        description: 'Number of products per shop to scrape (leave blank for all)'
        required: false
        default: '1500'

jobs:
  manual-scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Manual scrape with custom limit
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DJANGO_SETTINGS_MODULE: core.settings
          PYTHONPATH: /github/workspace/bdpricegear-backend
          PLAYWRIGHT_BROWSERS_PATH: 0
        working-directory: ./bdpricegear-backend
        run: |
          echo "ðŸ”„ Starting manual product scrape..."
          LIMIT="${{ github.event.inputs.limit }}"
          if [ -z "$LIMIT" ]; then
            python manage.py populate_products
          else
            python manage.py populate_products --limit $LIMIT
          fi
          echo "âœ… Products scraped and saved to Supabase"

      - name: Show database statistics
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DJANGO_SETTINGS_MODULE: core.settings
          PYTHONPATH: /github/workspace/bdpricegear-backend
        working-directory: ./bdpricegear-backend
        run: |
          python manage.py shell << 'EOF'
          from products.models import Product, Shop, Category
          products_count = Product.objects.count()
          shops_count = Shop.objects.count()
          categories_count = Category.objects.count()
          print(f"\nðŸ“Š Database Statistics:")
          print(f"   Total Products: {products_count}")
          print(f"   Total Shops: {shops_count}")
          print(f"   Total Categories: {categories_count}")
          EOF

      - name: âœ… Manual update completed
        if: success()
        run: echo "ðŸŽ‰ Manual scrape completed successfully"

      - name: âŒ Manual update failed
        if: failure()
        run: echo "âš ï¸ Manual scrape failed - check logs"
